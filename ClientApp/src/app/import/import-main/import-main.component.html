<main class="main-container">
    <h3> {{'import' | translate}}</h3>
    <p>
        {{'import-description' | translate}}
    </p>

    <ul class="tui-list tui-list_ordered tui-list_nested tui-text_body-s">
        <li class="tui-list__item"><b>OBB</b>: {{'obb-description' | translate}}
        </li>
        <li class="tui-list__item"><b>Localization</b>: {{'localization-description' | translate}} </li>
        <li class="tui-list__item"><b>Gamedata</b>: {{'gamedata-description' | translate}}</li>
    </ul>

    <div class="file-input-grid tui-space_top-6">
        <ng-container [ngTemplateOutlet]="fileInput" [ngTemplateOutletContext]="{
            $implicit: importS.obb,
            filesize:(1024*1024*1024*2),
            accept: '.obb',
            filename: 'OBB'
        }">
        </ng-container>
        <ng-container [ngTemplateOutlet]="fileInput" [ngTemplateOutletContext]="{
            $implicit: importS.localization,
            filesize:(1024*1024*100),
            accept: undefined,
            filename: 'Localization'
        }">
        </ng-container>
        <ng-container [ngTemplateOutlet]="fileInput" [ngTemplateOutletContext]="{
            $implicit: importS.gamedata,
            filesize:(1024*1024*100),
            accept: undefined,
            filename: 'Gamedata',
        }">
        </ng-container>
    </div>

    <tui-elastic-container>
        @if ((importS.filesVerified$ | async) ?? false) {
        @if (!(importS.obb.skip | async)) {
        <ng-container [ngTemplateOutlet]="configurationObb"></ng-container>
        }
        <ng-container [ngTemplateOutlet]="progressLog"></ng-container>

        <div class="import-button tui-space_vertical-6">
            @if (!(importS.importsCompleted$ | async)) {
            <button tuiButton appearance="outline" class="import-button"
                [loading]="(importS.isImporting$ | async) ?? false" (click)="importS.onImportBegins()"
                [disabled]="!(importS.filesVerified$ | async)"
                [tuiHint]="!(importS.filesVerified$ | async) ? ('missing-files-import' | translate) : undefined"
                [tuiHintAppearance]="!(importS.filesVerified$ | async) ? 'error' : 'onDark'" [tuiHintShowDelay]="100">
                {{'begin-import' | translate}}
            </button>
            }
            @else {
            <button tuiIconButton appearance="outline" type="button" style="width: 100%; padding-bottom: 1rem;"
                iconStart="@tui.circle-arrow-right" (click)="onNext()">
            </button>
            }
        </div>
        }
    </tui-elastic-container>
</main>

<ng-template #fileInput let-filecontrol let-filesize="filesize" let-accept="accept" let-filename="filename">
    <div class="file-input-empty">
        <ng-container [ngTemplateOutlet]="file" [ngTemplateOutletContext]="{
            $implicit: filecontrol,
            filesize:filesize,
            accept: accept,
            filename: filename,
            onreject: importS.onReject.bind(this.importS)
        }">
        </ng-container>

        @if (!filecontrol.control.value && !(filecontrol.skip | async) && (showSkipButton$ | async)) {
        <button class="right-top-button" tuiIconButton iconStart="@tui.circle-x" size="xs" appearance="icon"
            (click)="importS.onSkipFile(filecontrol)" [tuiHint]="'skip-file' | translate" tuiHintAppearance="dark">
        </button>
        }
    </div>
</ng-template>

<ng-template #file let-filecontrol let-filesize="filesize" let-accept="accept" let-filename="filename"
    let-onreject="onreject">
    @if (filecontrol.skip | async) {
    <div tuiCardLarge size="s" class="not-support"
        *ngIf="filecontrol.notSupported && filecontrol.notSupported | async; else skipN">
        <p class="text-blend tui-island__category">{{'not-support' | translate}}</p>
        <h3 class="text-blend tui-island__title">{{filename}}</h3>
        <p class="text-blend tui-island__paragraph">
            {{'not-support-mobile' | translate}}
        </p>
    </div>
    <ng-template #skipN>
        <div tuiCardLarge size="s" class="not-support">
            <p class="text-blend tui-island__category">{{'file-skip' | translate}}</p>
            <h3 class="text-blend tui-island__title">{{filename}}</h3>
            <p class="text-blend tui-island__paragraph">
                {{'file-import-skip-description' | translate}}
            </p>
        </div>
    </ng-template>
    }
    @else {
    <!-- TODO: (Taiga UI migration) Native input inside is now required and the wrapper has changed from <tui-input-files to <label tuiInputFiles, control moved to native input. See interactive example https://taiga-ui.dev/components/input-files -->
    <label tuiInputFiles *ngIf="!filecontrol.control.value" class="file-input" [formControl]="filecontrol.control"
        (reject)="onreject($event)" tuiTheme="light">
        <ng-template let-dragged>
            <div *ngIf="dragged; else base" class="content">
                <tui-avatar appearance="white" src="@tui.droplet" size="s"></tui-avatar>
                <div>
                    {{'drop' | translate}}
                </div>
                <input accept="image/*" tuiInputFiles [maxFileSize]="filesize" [accept]="accept" [multiple]="false"
                    [formControl]="filecontrol.control" />
            </div>
            <ng-template #base>
                <div class="content">
                    <tui-avatar appearance="white" src="@tui.cloud-upload" size="s"></tui-avatar>
                    <div>{{filename}}</div>
                </div>
            </ng-template>
        </ng-template>
    </label>
    <ng-container *ngIf="filecontrol.loadedFile$ | async as file">
        <div tuiCardLarge size="s" class="not-support">
            <tui-loader [overlay]="true" [showLoader]="(filecontrol.verifyingFile$ | async) ?? false"
                style="position: absolute; right: 0.5em; top: 0.5em;">
                <tui-icon [icon]="'@tui.circle-check'" style="position: relative; top: 0.25em;">
                </tui-icon>
            </tui-loader>
            <p class="tui-island__category">{{'archive' | translate}}</p>
            <h3 class="tui-island__title">{{filename}}</h3>
            <p class="text-blend tui-island__paragraph">
                {{
                (filecontrol.verifyingFile$ | async) ?? false ?
                ('file-import-verifying' | translate) :
                ('file-import-verified' | translate)
                }}
            </p>
        </div>
    </ng-container>
    }
</ng-template>

<ng-template #configurationObb>
    <p>{{'choose-languages' | translate}}</p>
    <p>
        {{'choose-languages-description' | translate}}
    </p>
    @if (importS.multiLanguage$ | async) {
    <tui-select tuiTextfieldSize="s" [formControl]="importS.defaultLanguage" class="tui-space_bottom-3"
        [valueContent]="originLang" size="s">
        {{'default-language' | translate}}
        <input tuiTextfieldLegacy placeholder="..." />
        <tui-data-list-wrapper *tuiDataList [items]="importS.languagesSelected" [itemContent]="originLang">
        </tui-data-list-wrapper>
        <ng-template #originLang let-data>
            {{data | translate}}
        </ng-template>
    </tui-select>
    }
    <div class="wizard-choose-lang">
        <label *ngFor="let language of importS.dialogAssets | keyvalue" tuiBlock="l"> <input tuiCheckbox type="checkbox"
                [(ngModel)]="importS.dialogAssetsInclude[language.key]"
                (ngModelChange)="importS.onSelectLanguage(language.key, $event)" class="lang-checkbox">
            <div class="content">
                <div>
                    <div class="label">{{language.key | translate}}</div>
                    {{'files' | translate}}: {{language.value.length}}
                </div>
            </div>
        </label>
    </div>
</ng-template>

<ng-template #progressLog>
    <div class="progress-badget-container tui-space_top-6 tui-space_bottom-1">
        <tui-badge appearance="warning" [tuiHint]="'skip-file-hint' | translate" tuiHintAppearance="dark">{{
            importS.operationsSkip$ | async }}
        </tui-badge>
        <tui-badge appearance="info" [tuiHint]="'replaced-file-hint' | translate" tuiHintAppearance="dark">{{
            importS.operationsUpdated$ | async }}
        </tui-badge>
    </div>
    <tui-scrollbar>
        <cdk-virtual-scroll-viewport itemSize="50" tuiScrollable style="display: block;
            width: calc(100% - 4px);
            height: 200px;
            border: 2px solid var(--tui-background-base-alt);" class="tui-zero-scrollbar">
            <table class="tui-table tui-table_font-size_s tui-table_layout_fixed">
                <thead>
                    <tr class="tui-table__tr tui-table__tr_border_none tui-table__tr_hover_disabled">
                        <th class="tui-table__th tui-table_layout_fixed" style="width: 150px;">{{'file' | translate}}
                        </th>
                        <th class="tui-table__th tui-table_layout_fixed">{{'message' | translate}}</th>
                        <th class="tui-table__th" style="width: 64px;"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr *cdkVirtualFor="let log of (importS.operations$ | async)"
                        class="tui-table__tr tui-table__tr_border_none">
                        <td class="tui-table__td tui-table__td_text_overflow">
                            {{log.file}}
                        </td>
                        <td class="tui-table__td tui-table__td_text_overflow">
                            <span [title]="log.translateKey | translate">{{ log.translateKey | translate}}</span>
                        </td>
                        <td class="tui-table__td">
                            <button appearance="icon" iconStart="@tui.chevron-right" tuiIconButton type="button"
                                size="xs">
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </cdk-virtual-scroll-viewport>
    </tui-scrollbar>
</ng-template>