<div tuiDropdownAlign="right" [tuiDropdown]="dropdown" [tuiDropdownSided]="true" [(tuiDropdownOpen)]="menuOpen">
    <button appearance="icon" tuiButton type="button" size="xs" [iconStart]="'@tui.book'"
        [tuiAppearanceState]="menuOpen || null ? 'active' : null">
    </button>
</div>
<ng-template #dropdown>
    <h4 style="text-align: center;">{{'dictionary' | translate}}</h4>
    <tui-data-list>
        <tui-opt-group>
            <button tuiOption (click)="onShowList(listTemplate, 'm')">
                <tui-icon icon="@tui.book-open"></tui-icon> {{'see-all' | translate}}
            </button>
            <button tuiOption (click)="onShowCreateNew(createTemplate, 'm')">
                <tui-icon icon="@tui.pencil"></tui-icon> {{'create-new' | translate}}
            </button>
        </tui-opt-group>
    </tui-data-list>
</ng-template>

<main class="main-form" #draggableElement *ngIf="!dialogState.isHidden"
    [ngStyle]="{'z-index': dialogState.zIndex$ | async}" (click)="changeIndex(dialogState)">
    <div class="main-form-header" appDraggableElement [elementRef]="draggableElement"
        [draggableElementState]="dialogState" [elementAnchorRef]="anchor">
        <p>{{'common-word-form' | translate}}</p>
        <button tuiIconButton class="tui-space_right-2" appearance="icon" [iconStart]="'@tui.x'" size="xs"
            (click)="dialogState.isHidden = !dialogState.isHidden">
        </button>
    </div>
    <tui-scrollbar class="main-form-content">
        <form [formGroup]="commonWordForm" style="padding: 0 1rem;">
            <div>
                <div>
                    <h3 class="tui-form__header tui-form__header_margin-top_none tui-space_top-4">
                        {{'content' | translate}}
                    </h3>
                    <div class="tui-form__row">
                        <tui-input formControlName="Original" tuiTextfieldSize="m">
                            {{'original-word' | translate}}
                            <input placeholder="***" tuiTextfieldLegacy />
                            <span class="tui-required"></span>
                        </tui-input>
                    </div>
                    <div class="tui-form__row">
                        <tui-input formControlName="Translation" tuiTextfieldSize="m">
                            {{'translation' | translate}}
                            <input placeholder="***" tuiTextfieldLegacy />
                            <span class="tui-required"></span>
                        </tui-input>
                    </div>
                </div>
            </div>
        </form>

        <div class="main-form-actions tui-space_top-3 tui-space_bottom-3">
            <ng-container *ngIf="!(commonWords.createOther$ | async); else createOther">
                <button tuiButton [iconStart]="'@tui.circle-check'" (click)="onCreateKey()" size="m"
                    [loading]="(commonWords.creating$ | async) ?? false" [disabled]="commonWordForm.invalid"
                    [tuiHint]="(commonWordForm.invalid) ? ('form-error' | translate) : undefined"
                    tuiHintAppearance="error" appearance="outline">
                    {{'create' | translate}}
                </button>
            </ng-container>
            <ng-template #createOther>
                <button tuiButton [iconStart]="'@tui.circle-check'" (click)="onCreateOther()" size="m"
                    appearance="outline">
                    {{'created-other' | translate}}
                </button>
            </ng-template>
        </div>
    </tui-scrollbar>
</main>

<ng-template #createTemplate>
    <tui-scrollbar class="main-form-content">
        <form [formGroup]="commonWordForm" style="padding: 0 1rem;">
            <div>
                <div>
                    <h3 class="tui-form__header tui-form__header_margin-top_none tui-space_top-4">
                        {{'content' | translate}}
                    </h3>
                    <div class="tui-form__row">
                        <tui-input formControlName="Original" tuiTextfieldSize="m">
                            {{'original-word' | translate}}
                            <input placeholder="***" tuiTextfieldLegacy />
                            <span class="tui-required"></span>
                        </tui-input>
                    </div>
                    <div class="tui-form__row">
                        <tui-input formControlName="Translation" tuiTextfieldSize="m">
                            {{'translation' | translate}}
                            <input placeholder="***" tuiTextfieldLegacy />
                            <span class="tui-required"></span>
                        </tui-input>
                    </div>
                </div>
            </div>
        </form>

        <div class="main-form-actions tui-space_top-3 tui-space_bottom-3">
            <ng-container *ngIf="!(commonWords.createOther$ | async); else createOther">
                <button tuiButton [iconStart]="'@tui.circle-check'" (click)="onCreateKey()" size="m"
                    [loading]="(commonWords.creating$ | async) ?? false" [disabled]="commonWordForm.invalid"
                    [tuiHint]="(commonWordForm.invalid) ? ('form-error' | translate) : undefined"
                    tuiHintAppearance="error" appearance="outline">
                    {{'create' | translate}}
                </button>
            </ng-container>
            <ng-template #createOther>
                <button tuiButton [iconStart]="'@tui.circle-check'" (click)="onCreateOther()" size="m"
                    appearance="outline">
                    {{'created-other' | translate}}
                </button>
            </ng-template>
        </div>
    </tui-scrollbar>
</ng-template>

<main class="main-list" #draggableListElement *ngIf="!listDialogState.isHidden"
    [ngStyle]="{'z-index': listDialogState.zIndex$ | async}" (click)="changeIndex(listDialogState)"
    (touchstart)="changeIndex(listDialogState)">
    <div class="main-form-header" appDraggableElement [elementRef]="draggableListElement"
        [draggableElementState]="listDialogState" [elementAnchorRef]="anchor">
        <p>{{'dictionary' | translate}}</p>
        <button tuiIconButton class="tui-space_right-2" appearance="icon" [iconStart]="'@tui.x'" size="xs"
            (click)="listDialogState.isHidden = !listDialogState.isHidden"
            (touchstart)="listDialogState.isHidden = !listDialogState.isHidden" aria-label="Close dialog">
        </button>
    </div>

    <ng-container [ngTemplateOutlet]="listTemplate"></ng-container>
</main>

<ng-template #listTemplate>
    <h4 class="tui-space_horizontal-3">{{'dictionary-description' | translate}}</h4>

    <ng-container *ngIf="commonWords.words as words">
        <tui-scrollbar #scroll class="viewport" [class.viewport-dialog]="(breakpointService$| async) === 'mobile'">
            <cdk-virtual-scroll-viewport *ngIf="words.length > 0; else emptyWords" #viewport tuiScrollable
                [style.height.px]="scroll['el']['offsetHeight'] - 16"
                class="main-form-content tui-space_horizontal-3 tui-space_bottom-3 tui-zero-scrollbar" [itemSize]="33">
                <table class="tui-table" style="table-layout: fixed;" tuiTable
                    [columns]="['Original', 'Translation', 'custom', 'confirmDelete']" [size]="'s'" [@popIn]
                    *ngIf="commonWords.change$ | async">
                    <thead>
                        <tr tuiThGroup>
                            <th tuiTh *tuiHead="'Original'" [sticky]="true"
                                [style.top.px]="-viewport['_renderedContentOffset']" [sorter]="null">
                                {{'original-word' | translate}}
                            </th>
                            <th tuiTh *tuiHead="'Translation'" [sticky]="true"
                                [style.top.px]="-viewport['_renderedContentOffset']" [sorter]="null">
                                {{'translation' | translate}}
                            </th>
                            <th tuiTh *tuiHead="'custom'" [sticky]="true" style="width: 64px;"
                                [style.top.px]="-viewport['_renderedContentOffset']" [sorter]="null">
                            </th>
                            <th tuiTh *tuiHead="'confirmDelete'" style="width: 0px; padding: 0; border: none;"
                                [style.top.px]="-viewport['_renderedContentOffset']" [sorter]="null">
                            </th>
                        </tr>
                    </thead>
                    <tbody tuiTbody>
                        <tr *cdkVirtualFor="let w of words; index as i" tuiTr>
                            <td *tuiCell="'Original'" tuiTd>
                                <tui-input [(ngModel)]="w.Original" tuiTextfieldSize="s">
                                    {{'original-word' | translate}}
                                    <input placeholder="***" tuiTextfieldLegacy />
                                </tui-input>
                            </td>
                            <td *tuiCell="'Translation'" tuiTd>
                                <tui-input [(ngModel)]="w.Translation" tuiTextfieldSize="s">
                                    {{'translation' | translate}}
                                    <input placeholder="***" tuiTextfieldLegacy />
                                </tui-input>
                            </td>
                            <td *tuiCell="'custom'" tuiTd>
                                <div style="display: flex; align-items: center; justify-content: center;">
                                    <tui-loader [showLoader]="(w.loader | async) ?? false" [inheritColor]="true"
                                        [overlay]="true">
                                        <button appearance="flat" iconStart="@tui.trash" [style.border-radius.%]="100"
                                            size="xs" aria-label="remove word" tuiIconButton type="button"
                                            (click)="commonWords.confirmDelete(w);">
                                        </button>
                                    </tui-loader>
                                    <tui-loader [showLoader]="(w.loader | async) ?? false" [inheritColor]="true"
                                        [overlay]="true">
                                        <button appearance="flat" iconStart="@tui.save" [style.border-radius.%]="100"
                                            size="xs" aria-label="update word" tuiIconButton type="button"
                                            (click)="commonWords.update(w)">
                                        </button>
                                    </tui-loader>
                                </div>
                            </td>
                            <ng-template [ngIf]="(w.confirm | async) ?? false">
                                <td *tuiCell="'confirmDelete'" class="confirm-delete-column" [@fadeIn]>
                                    <p class="text">{{'confirm-text-delete-word' | translate}}</p>
                                    <button tuiButton size="xs" class="tui-space_left-2"
                                        (click)="commonWords.delete(w, i)"
                                        [loading]="(commonWords.deleting$ | async) ?? false" appearance="accent">
                                        {{'confirm-frienly' | translate}}
                                    </button>
                                    <button tuiButton size="xs" class="tui-space_left-2"
                                        (click)="commonWords.cancelDelete(w)"
                                        [loading]="(commonWords.deleting$ | async) ?? false" appearance="flat">
                                        {{'unconfirm-frienly' | translate}}
                                    </button>
                                </td>
                            </ng-template>
                        </tr>
                    </tbody>
                </table>
            </cdk-virtual-scroll-viewport>
            <ng-template #emptyWords>
                <hr>
                <tui-block-status>
                    <h4>{{'empty-dictionary' | translate}}</h4>
                    <span>{{'create-one' | translate}}</span>
                    <button tuiButton [size]="'m'" (click)="onShowCreateNew(createTemplate, 'fullscreen')">
                        {{'go' | translate }}
                    </button>
                </tui-block-status>
            </ng-template>
        </tui-scrollbar>
    </ng-container>
</ng-template>

<div #anchor style="position: absolute;"></div>