@if ((languageOrigin.language.value)) {
  <main class="main-container">
    <div class="files">
      <h3>{{'translation-progress' | translate}}</h3>
      <p>
        {{'translation-progress-description' | translate}}
      </p>
      @if ({values: eTS.progressPerc$ | async}; as progress;) {
        <ol class="tui-list tui-list_ordered tui-list_nested tui-text_body-s"
          [style.--tui-skeleton-radius.px]="4">
          <li class="tui-list__item">
            {{'translation-ui' | translate}}
            → <b [class.tui-skeleton]="!progress.values">
            {{progress.values?.Keys | number:'1.2-2'}}%
          </b>
        </li>
        <li class="tui-list__item">
          {{'translation-dialogs' | translate}}
          → <b [class.tui-skeleton]="!progress.values">
          {{progress.values?.Dialogs | number:'1.2-2'}}%
        </b>
      </li>
    </ol>
  }
  <tui-tabs-with-more [itemsLimit]="3" underline="var(--tui-background-accent-opposite)"
    [(activeItemIndex)]="activeItemIndex" class="tui-space_top-6 tui-space_bottom-3" size="m">
    <button *tuiItem iconStart="gamepad" tuiTab type="button">
      {{'export-to-game' | translate}}
    </button>
    <button *tuiItem iconStart="file-down" tuiTab type="button">
      {{'export-to-file' | translate}}
    </button>
  </tui-tabs-with-more>
  @switch(activeItemIndex){
    @case (0) {
      <ng-container [ngTemplateOutlet]="exportToGame" />
    }
    @case (1) {
      <ng-container [ngTemplateOutlet]="exportToFile" />
    }
  }
</div>
</main>
} @else {
  <tui-block-status class="empty-lang-container">
    <img tuiSlot="top" alt="main localization" src="./assets/images/localization-not.svg"
      class="tui-space_vertical-6 image" />
    <h4 style="max-width: 500px;" tuiSlot="top">{{'empty-db-guest' | translate}}</h4>
  </tui-block-status>
}


<ng-template #file let-filecontrol let-filesize="filesize" let-accept="accept" let-filename="filename"
  let-onreject="onreject">
  <div class="file-input-empty">
    @if (filecontrol.skip | async) {
      @if (filecontrol.notSupported && filecontrol.notSupported | async) {
        <div tuiCardMedium="compact" tuiAppearance="neutral" class="file-input file-input-provided"
          >
          <header tuiHeader>
            <h2 tuiTitle>
              {{'not-support' | translate}}
              <span tuiSubtitle>{{filename}}</span>
            </h2>
          </header>
          <section>
            <span>{{'not-support-mobile' | translate}}</span>
          </section>
          <footer>
          </footer>
        </div>
      } @else {
        <div tuiCardMedium="compact" tuiAppearance="neutral" class="file-input file-input-provided">
          <header tuiHeader>
            <h2 tuiTitle>
              {{'file-skip' | translate}}
              <span tuiSubtitle>{{filename}}</span>
            </h2>
          </header>
          <section>
            {{'file-skip-description' | translate}}
          </section>
          <footer>
          </footer>
        </div>
      }
    }
    @else if (!filecontrol.control.value) {
    <label tuiInputFiles class="file-input">
      <input accept="image/*" tuiInputFiles [maxFileSize]="filesize" [accept]="accept" [multiple]="false"
        [formControl]="filecontrol.control" />
      <ng-template let-dragged>
        @if (dragged) {
          <div class="content">
            <tui-avatar appearance="white" src="@tui.droplet" size="s"></tui-avatar>
            <div>{{'drop' | translate}}</div>
          </div>
        } @else {
          <div class="content">
            <tui-avatar appearance="white" src="@tui.cloud-upload" size="s"></tui-avatar>
            <div>{{filename}}</div>
          </div>
        }
      </ng-template>
    </label>
  }
  @if (filecontrol.loadedFile$ | async; as file) {
    <div tuiCardMedium="compact" tuiAppearance="neutral" class="file-input file-input-provided">
      <header tuiHeader>
        <h2 tuiTitle>
          {{'archive' | translate}}
          <span tuiSubtitle>{{filename}}</span>
        </h2>

        <aside tuiAccessories>
          <tui-loader class="file-verified-loader" [overlay]="true"
            [showLoader]="(filecontrol.verifyingFile$ | async) ?? false">
            <tui-icon [icon]="'@tui.circle-check'" />
          </tui-loader>
        </aside>
      </header>
      <section>
        <p>
          {{'progress' | translate}}: {{((filecontrol.progress$ | async) |
          number:'1.0-2')}}/{{(filecontrol.progressMax$ | async)}}
        </p>
      </section>
      <footer>
        @if (filecontrol.url) {
          <a tuiLink href="{{filecontrol.url}}" download="{{filecontrol.control.value.name}}"
            appearance="action-grayscale" [pseudo]="true">
            {{'download' | translate}}
          </a>
        }
        @else {
        <p>{{(filecontrol.progressStatus$ | async) ?? '' | translate}}</p>
      }
    </footer>
  </div>
}

@if (!filecontrol.control.value && !(filecontrol.skip | async)) {
  <button class="skip-button" tuiIconButton iconStart="@tui.circle-x" size="xs" appearance="icon"
    (click)="eTS.onSkipFile(filecontrol)" aria-label="skip button">
  </button>
}
</div>
</ng-template>

<ng-template #exportToGame>
  <h3 class="tui-space_top-6">{{'to-translate' | translate}}</h3>
  <p>{{'to-translate-description' | translate}}</p>
  <ul class="tui-list tui-list_ordered tui-list_nested tui-text_body-s">
    <li class="tui-list__item"><b>OBB</b>: {{'obb-description' | translate}}
  </li>
  <li class="tui-list__item"><b>Localization</b>: {{'localization-description' | translate}} </li>
  <li class="tui-list__item"><b>Gamedata</b>: {{'gamedata-description' | translate}}</li>
</ul>

<div class="files-input tui-space_top-6">
        <ng-container [ngTemplateOutlet]="file" [ngTemplateOutletContext]="{
                    $implicit: eTS.obb,
                    filesize:(1024*1024*1024*2),
                    accept: '.obb',
                    filename: 'OBB',
                    onreject: eTS.onReject.bind(this.eTS),
                }">
  </ng-container>
        <ng-container [ngTemplateOutlet]="file" [ngTemplateOutletContext]="{
                    $implicit: eTS.localization,
                    filesize:(1024*1024*100),
                    accept: '*',
                    filename: 'Localization',
                    onreject: eTS.onReject.bind(this.eTS)
                }">
  </ng-container>
        <ng-container [ngTemplateOutlet]="file" [ngTemplateOutletContext]="{
                    $implicit: eTS.gamedata,
                    filesize:(1024*1024*100),
                    accept: '*',
                    filename: 'Gamedata',
                    onreject: eTS.onReject.bind(this.eTS)
                }">
  </ng-container>
</div>

<tui-expand [expanded]="(eTS.filesVerified$ | async) && !(eTS.filesCompleted$ | async)">
  <ng-template tuiExpandContent>
    <!-- <p>
    {{'before-translation-apply-0' | translate}}
    <span class="important-text">Buy Me a Coffee</span>.
    {{'before-translation-apply-1' | translate}}
  </p>

  <p>
    {{'before-translation-apply-2' | translate}}
  </p> -->

  <p class="important-text">
    {{'before-translation-apply-3' | translate}}
  </p>
</ng-template>
</tui-expand>

<tui-expand [expanded]="(eTS.filesCompleted$ | async)">
  <p class="important-text">
    {{'after-translation-apply-0' | translate}}
  </p>

  <p>
    {{'after-translation-apply-1' | translate}}
  </p>

  <!-- <p>
  {{'after-translation-apply-2' | translate}}
</p> -->
</tui-expand>

<div class="translate-button tui-space_vertical-6">
  @if (!(eTS.filesCompleted$ | async)) {
    <button tuiButton appearance="outline"
      [loading]="(eTS.isTranslating$ | async) ?? false" (click)="eTS.onApplyTranslation()"
      [disabled]="!(eTS.filesVerified$ | async)"
      [tuiHint]="!(eTS.filesVerified$ | async) ? ('missing-files' | translate) : undefined"
      [tuiHintAppearance]="!(eTS.filesVerified$ | async) ? 'error' : 'onDark'" [tuiHintShowDelay]="100">
      {{'apply-translation' | translate}}
    </button>
  }
  @if ((eTS.filesCompleted$ | async)) {
    <button tuiButton appearance="outline">
      {{'after-translation-apply-3' | translate}}
    </button>
  }
</div>
</ng-template>

<ng-template #exportToFile>
  <h3 class="tui-space_top-6">{{'to-share' | translate}}</h3>
  <p>{{'to-share-description' | translate}}</p>

  <tui-scrollbar class="tui-space_bottom-6">
    <cdk-virtual-scroll-viewport itemSize="50" tuiScrollable class="tui-zero-scrollbar progress-operation-scroll">
      <table class="tui-table tui-table_font-size_s tui-table_layout_fixed">
        <thead>
          <tr class="tui-table__tr tui-table__tr_border_none tui-table__tr_hover_disabled">
            <th class="tui-table__th tui-table_layout_fixed">
              {{'message' | translate}}
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *cdkVirtualFor="let item of eTS.exportMessages()"
            class="tui-table__tr tui-table__tr_border_none">
            <td class="tui-table__td tui-table__td_text_overflow">
              {{item | translate}}
            </td>
          </tr>
        </tbody>
      </table>
    </cdk-virtual-scroll-viewport>
  </tui-scrollbar>

  <div class="translate-button tui-space_vertical-6">
    @if (eTS.exportStatus() === 'waiting') {
      <button tuiButton appearance="outline" [loading]="(eTS.isTranslating$ | async) ?? false"
        (click)="eTS.onExportTranslation()">
        {{'export' | translate}}
      </button>
    }
    @else if (eTS.exportStatus() !== 'waiting' && eTS.exportStatus() !== 'finish') {
    <button tuiButton appearance="outline" [loading]="true">
      {{'export' | translate}}
    </button>
  }
  @else if (eTS.exportStatus() === 'finish') {
  <button tuiButton appearance="outline">
    {{'export-translation-finish' | translate}}
  </button>
}
</div>
</ng-template>